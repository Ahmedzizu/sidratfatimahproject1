const resortValidation = require("../validation/resortValidation")
const Resort=require("../model/resort")
const Reservation = require("../model/reservation");
const multer = require("multer");

// ุฅุนุฏุงุฏ `multer` ูุงุณุชูุจุงู ุงูุตูุฑ ูุงูููุฏูููุงุช
const storage = multer.memoryStorage();
const upload = multer({ storage: storage }).fields([
  { name: "file[]", maxCount: 10 }, 
  { name: "videos[]", maxCount: 5 }
]);

const resort={

     postResort : [
        upload, // ุชุดุบูู `multer` ููุนุงูุฌุฉ `Form Data` ูุงููููุงุช
        async (req, res) => {
          try {
            console.log("๐ฅ Received Request Body:", req.body);
            console.log("๐ธ Received Files:", req.files);
      
            // ูุนุงูุฌุฉ ุงููููุงุช (ุงูุตูุฑ ูุงูููุฏูููุงุช)
            let images = req.files["file[]"] ? req.files["file[]"].map(file => `/resort/img/${file.originalname}`) : [];
            let videos = req.files["videos[]"] ? req.files["videos[]"].map(file => `/resort/videos/${file.originalname}`) : [];
      
            // ุงุณุชุฎุฑุงุฌ ุงูุญููู ูู `req.body`
            let {
              name,
              kitchen,
              pool,
              games,
              nightPrice,
              morningPrice,
              wholeDayPrice,
              area,
              dayStartHour,
              dayEndHour,
              nightStartHour,
              nightEndHour
            } = req.body;
      
            // ุงูุชุฃูุฏ ูู ุชุญููู ุงูููู ุงูุฑูููุฉ
            kitchen = parseInt(kitchen) || 0;
            pool = parseInt(pool) || 0;
            games = parseInt(games) || 0;
            nightPrice = parseFloat(nightPrice) || 0;
            morningPrice = parseFloat(morningPrice) || 0;
            wholeDayPrice = parseFloat(wholeDayPrice) || 0;
            area = parseInt(area) || 0;
      
            // ุงูุชุฃูุฏ ูู ุฃู `details[]` ูุตูููุฉ
            let details = req.body["details[]"] || [];
            if (!Array.isArray(details)) {
              details = [details];
            }
      
            // ุงูุชุญูู ูู ุงูุญููู ุงููุทููุจุฉ
            if (!name || !area || !kitchen || !pool || !games || !dayStartHour || !dayEndHour || !nightStartHour || !nightEndHour) {
              return res.status(400).send({ error: "ุฌููุน ุงูุญููู ูุทููุจุฉ!" });
            }
      
            // ุฅูุดุงุก ุจูุงูุงุช ุงูููุชุฌุน
            const resort = new Resort({
              name,
              videos,
              images,
              pool,
              kitchen,
              games,
              price: {
                night: nightPrice,
                morning: morningPrice,
                wholeDay: wholeDayPrice
              },
              details,
              area,
              dayStartHour,
              dayEndHour,
              nightStartHour,
              nightEndHour
            });
      
            // ุญูุธ ุงูููุชุฌุน ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
            await resort.save();
            console.log("โ Resort Created Successfully:", resort);
            res.sendStatus(201);
          } catch (error) {
            console.error("๐ฅ Error while creating resort:", error.message);
            res.status(500).send({ error: error.message });
          }
        }
      ],

getResort:async(req,res)=>{
    try {
        let resorts= await Resort.find()
        res.send(resorts)
    } catch (error) {
        console.log(error.message);
        res.status(500).send({error:error.message})
    }
},

getResortsByDate: async (req, res) => {
  try {
      const { date } = req.body;
      if (!date) return res.status(400).send({ error: "Date is required" });

      // โ ุชุญููู ุงูุชุงุฑูุฎ ุฅูู ISOString ููููู ูุทุงุจููุง ููุงุนุฏุฉ ุงูุจูุงูุงุช
      const formattedDate = new Date(date).toISOString().split('T')[0];
      console.log("๐ ุงูุจุญุซ ุนู ุงูุญุฌูุฒุงุช ุจุชุงุฑูุฎ:", formattedDate);

      let resorts = await Resort.find(); // โ ุฌูุจ ุฌููุน ุงูููุชุฌุนุงุช
      console.log(`๐๏ธ ุนุฏุฏ ุงูููุชุฌุนุงุช ุงููุณุชุฑุฌุนุฉ: ${resorts.length}`);

      // โ ุฌูุจ ุงูุญุฌูุฒุงุช ุงููุคูุฏุฉ ุจุงุณุชุฎุฏุงู ุชูุณูู ุงูุชุงุฑูุฎ ุงูุตุญูุญ
      let reservations = await Reservation.find({
          "period.startDate": { $lte: formattedDate },
          "period.endDate": { $gte: formattedDate },
          status: "confirmed",
          type: "resort",
      });

      console.log(`๐ ุนุฏุฏ ุงูุญุฌูุฒุงุช ุงูููุฌูุฏุฉ ููุฐุง ุงูุชุงุฑูุฎ: ${reservations.length}`);

      let updatedResorts = resorts.map(resort => {
          let resortReservations = reservations.filter(res => {
              return res.entity.id.toString() === resort._id.toString();
          });

          console.log(`โณ ุนุฏุฏ ุงูุญุฌูุฒุงุช ููุฐุง ุงูููุชุฌุน (${resort.name}): ${resortReservations.length}`);

          let availability = "ูุชุงุญ ูููุชุฑุชูู";
          let isFullDayBooked = resortReservations.some(res => res.period.dayPeriod === "ูุงูู ุงูููู");

          if (isFullDayBooked) {
              availability = "ุบูุฑ ูุชุงุญ";
              console.log(`โ ${resort.name} ุบูุฑ ูุชุงุญ ููุงูู ุงูููู!`);
          } else {
              let morningBooked = resortReservations.some(res => res.period.dayPeriod === "ุตุจุงุญูุฉ" || res.period.type === "days");
              let eveningBooked = resortReservations.some(res => res.period.dayPeriod === "ูุณุงุฆูุฉ" || res.period.type === "days");

              if (morningBooked && eveningBooked) {
                  availability = "ุบูุฑ ูุชุงุญ";
                  console.log(`โ ${resort.name} ุบูุฑ ูุชุงุญ ููุตุจุงุญูุฉ ูุงููุณุงุฆูุฉ!`);
              } else if (morningBooked) {
                  availability = "ูุชุงุญ ูุณุงุกู";
                  console.log(`๐ ${resort.name} ูุชุงุญ ูููุณุงุก ููุท`);
              } else if (eveningBooked) {
                  availability = "ูุชุงุญ ุตุจุงุญูุง";
                  console.log(`โ๏ธ ${resort.name} ูุชุงุญ ููุตุจุงุญ ููุท`);
              }
          }

          return { ...resort._doc, availability };
      });

      console.log("โ ุฅุฑุณุงู ุงููุชุงุฆุฌ ุงูููุงุฆูุฉ:", updatedResorts);
      res.send(updatedResorts);
  } catch (error) {
      console.log("๐ฅ ุฎุทุฃ ุฃุซูุงุก ุฌูุจ ุงูููุชุฌุนุงุช:", error.message);
      res.status(500).send({ error: error.message });
  }
},


deleteResort:async(req,res)=>{
    try {
        let {id}=req.params
        await Resort.findByIdAndDelete({_id:id})
        .then(()=> res.sendStatus(202))
        .catch((err)=>res.status(500).send(err))
    } catch (error) {
        console.log(error.message);
        res.status(500).send({error:error.message})
    }
},


 updateResort : [
    upload, // ุชุดุบูู `multer` ููุนุงูุฌุฉ `Form Data` ูุงููููุงุช
    async (req, res) => {
      try {
        console.log("๐ฅ Received Request Body (UPDATE):", req.body);
        console.log("๐ธ Received Files (UPDATE):", req.files);
  
        // ุงุณุชุฎุฑุงุฌ `ID` ููุชุญูู ูู ูุฌูุฏ ุงูููุชุฌุน
        let { _id } = req.body;
        if (!_id) {
          return res.status(400).send({ error: "ูุฌุจ ุฅุฑุณุงู ูุนุฑู ุงูููุชุฌุน (_id)!" });
        }
  
        // ุงูุจุญุซ ุนู ุงูููุชุฌุน ููุชุฃูุฏ ูู ูุฌูุฏู ูุจู ุงูุชุญุฏูุซ
        let existingResort = await Resort.findById(_id);
        if (!existingResort) {
          return res.status(404).send({ error: "ุงูููุชุฌุน ุบูุฑ ููุฌูุฏ!" });
        }
  
        // ุงุณุชุฎุฑุงุฌ ุงูุจูุงูุงุช ูุน ุงูุญูุงุธ ุนูู ุงูููู ุงููุฏููุฉ ุฅุฐุง ูู ูุชู ุฅุฑุณุงู ุฌุฏูุฏุฉ
        let {
          name = existingResort.name,
          kitchen = existingResort.kitchen,
          pool = existingResort.pool,
          games = existingResort.games,
          nightPrice = existingResort.price.night,
          morningPrice = existingResort.price.morning,
          wholeDayPrice = existingResort.price.wholeDay,
          area = existingResort.area,
          dayStartHour = existingResort.dayStartHour,
          dayEndHour = existingResort.dayEndHour,
          nightStartHour = existingResort.nightStartHour,
          nightEndHour = existingResort.nightEndHour,
        } = req.body;
  
        // ุชุญููู ุงูููู ุงููุตูุฉ ุฅูู ุฃุฑูุงู ุนูุฏ ุงูุญุงุฌุฉ
        kitchen = parseInt(kitchen) || existingResort.kitchen;
        pool = parseInt(pool) || existingResort.pool;
        games = parseInt(games) || existingResort.games;
        nightPrice = parseFloat(nightPrice) || existingResort.price.night;
        morningPrice = parseFloat(morningPrice) || existingResort.price.morning;
        wholeDayPrice = parseFloat(wholeDayPrice) || existingResort.price.wholeDay;
        area = parseInt(area) || existingResort.area;
  
        // ูุนุงูุฌุฉ `details`
        let details = req.body["details[]"] || existingResort.details;
        if (!Array.isArray(details)) {
          details = [details];
        }
  
        // ูุนุงูุฌุฉ ุงูุตูุฑ ุงูุฌุฏูุฏุฉ ุฅุฐุง ุชู ุฑูุนูุง
        let images = existingResort.images;
        if (req.files && req.files["file[]"]) {
          let newImages = req.files["file[]"].map(file => `/resort/img/${file.originalname}`);
          images = [...existingResort.images, ...newImages]; // **ุฏูุฌ ุงูุตูุฑ ุงูุฌุฏูุฏุฉ ูุน ุงููุฏููุฉ**
        }
  
        // ูุนุงูุฌุฉ ุงูููุฏูููุงุช ุงูุฌุฏูุฏุฉ ุฅุฐุง ุชู ุฑูุนูุง
        let videos = existingResort.videos;
        if (req.files && req.files["videos[]"]) {
          let newVideos = req.files["videos[]"].map(file => `/resort/videos/${file.originalname}`);
          videos = [...existingResort.videos, ...newVideos]; // **ุฏูุฌ ุงูููุฏูููุงุช ุงูุฌุฏูุฏุฉ ูุน ุงููุฏููุฉ**
        }
  
        // ุชุญุฏูุซ ุจูุงูุงุช ุงูููุชุฌุน
        const updatedResort = await Resort.findByIdAndUpdate(
          _id,
          {
            name,
            images,
            videos,
            pool,
            kitchen,
            games,
            price: {
              night: nightPrice,
              morning: morningPrice,
              wholeDay: wholeDayPrice
            },
            details,
            area,
            dayStartHour,
            dayEndHour,
            nightStartHour,
            nightEndHour
          },
          { new: true }
        );
  
        console.log("โ Resort Updated Successfully:", updatedResort);
        res.status(200).send(updatedResort);
      } catch (error) {
        console.error("๐ฅ Error while updating resort:", error.message);
        res.status(500).send({ error: error.message });
      }
    }
  ],


}

module.exports =resort